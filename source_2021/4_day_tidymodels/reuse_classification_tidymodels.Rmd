---
title: "Classification with Tidymodels"
date: 2021-09-28T10:00:00+09:00
output:
  html_document:
    keep_md: true
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 개요

-   새로운 ML 라이브러리인 `tidymodels`를 활용하여 분류 모델을 개발해본다.

## 데이터

-   데이터는 `Loan Prediction Practice Problem`에서 가져왔다.

    -   URL: <https://datahack.analyticsvidhya.com/contest/practice-problem-loan-prediction-iii/#ProblemStatement>

-   회원가입 후, 대회 참여를 하면 3개의 파일을 다운로드 받을 수 있다.

    -   Train file, Test file, Submission File

### Data Dictionary

-   `Train 파일`의 데이터 명세서는 다음과 같다. ![](img/train.png)

-   `Test 파일`의 데이터 명세서는 다음과 같다. ![](img/test.png)

-   `Submission 파일`의 데이터 명세서는 다음과 같다. ![](img/submission.png)

## 대회목적

-   대출 승인 여부를 결정하는 모델을 만드는 것이 대회의 주 목적이며. 평가지표는 분류모형의 `Accurarcy`로 결정한다.

## 패키지 및 데이터 불러오기

-   먼저 필수 패키지를 불러온다.

```{r, message=FALSE}
# 데이터 수집
library(readr)

# 데이터 가공
library(dplyr) # 데이터 가공
library(tidyr) # 컬럼 변경
library(stringr) # 문자열 데이터 다루기 
library(forcats) # 범주형 데이터 다루기
library(skimr) # 데이터 요약
library(magrittr) # 파이프라인 작성


# 데이터 시각화
library(ggplot2) # 데이터 시각화 
library(corrr) # 상관관계 시각화
library(skimr) # 데이터 요약
library(patchwork) # 데이터 시각화 분할
library(GGally) # 산점도

# 데이터 모델링
library(tidymodels) # ML Packages 
library(themis) # class imbalance 처리
library(discrim) # 베이지안 모델링
library(tidyposterior) # 베이지안 모델링 성능 비교
library(doParallel) # CPU cores 확인
```

-   이번에는 데이터를 불러오도록 한다.

```{r}

```

-   총 614개의 데이터에 13개의 컬럼이 있다.

## 탐색적 자료분석 (EDA)

-   우선 skim() 함수를 활용하도록 한다.

```{r}

```

## 데이터 시각화

-   데이터 시각화의 기본적인 가이드라인은 아래 그림을 참조 한다.

    -   [20 ideas for better data visualization](https://uxdesign.cc/20-ideas-for-better-data-visualization-73f7e3c2782d)

![](img/viz_guideline_20.jpeg)

### 단변량 시각화

-   각 개별적인 컬럼에 대해 시각화를 자동으로 할 수 있는 코드를 작성해본다.

```{r, fig.width=10, fig.height=10, message=FALSE, warning=FALSE}

```

-   위 데이터를 간단하게 설명하면 다음과 같다.

    -   대출 지원자의 성별은 남성이 여성보다 많다.
    -   대출 지원자의 결혼 유무는 기혼자가 더 많다.
    -   대출 지원자 중 상당수는 자녀가 없다.
    -   대출 지원자 중 상당수는 대학을 졸업했고, `self-employed`가 아니다.
    -   대출 지원자의 수입은 `right skewed`이다.
    -   `co-applicant`의 수입도 `right skewed`이다.
    -   대출 지원자 중 약 2/3은 대출을 승인받았다.

### 양적 변수 시각화

-   양적 변수 시각화를 하기 위해서는 산점도를 작성하는 것이 좋다.
-   관계성을 파악하기에도 매우 유용하다.

```{r, fig.width=10, fig.height=10, message=FALSE, warning=FALSE}

```

### 질적 변수 시각화

-   이번에는 질적 변수 시각화를 진행하도록 한다.
-   우선, 질적 변수 시각화를 진행하기에 앞서서 평균과 신뢰구간을 구하도록 한다.
-   평균을 구하려면 우선 숫자 데이터를 만들어야 하는데, `Loan_Status` 대출을 승인받았으면 1, 그렇지 않으면 0이라고 표시를 한다.

```{r}

```

-   이제 시각화를 그려본다.

```{r}

```

-   간단하게 요약하면 다음과 같다.

    -   Married 지원자가 대출을 승인 받을 가능성이 더 높다.
    -   대졸자가 그렇지 않은 사람보다 대출을 승인 받을 가능성이 더 높다.\
    -   자녀들 변수는 큰 영향이 없는 것으로 보인다.
    -   여성 신청자수는 변동성이 큰 반면, 남성들의 경우 상대적으로 변동성이 작아 보인다.
    -   Credit History의 유무에 따라 매우 큰 변동성이 있는 것으로 확인되었다.

## 데이터 분리

-   약 8:2로 데이터를 분리하도록 하는데, Loan_Status의 비율에 따라서 층화추출(Stratified Sampling) 방식을 취하도록 한다.

```{r}

```

## 모델 개발

-   분류 모형을 개발하도록 한다.
-   이때, logistic, decision tree, random forest, xgboost 총 4개의 모델을 개발하도록 한다.

```{r}

```

## Feature Engineering

-   `tidymodels`에서는 feature engineering을 수행하기 위해 recipe 함수를 적용한다.
-   결측치 처리를 위해 bagged tree models, impute_mean, impute_node 등을 사용했다.

```{r}

```

-   모델 개발을 위해 recipe_1를 적용한 train, validation 데이터를 준비한다.
-   실제 테스트 데이터가 존재하기 때문에, 여기에서는 validation 이라고 명명했다.

```{r}

```

### Correlation Graph

-   실제 변환된 데이터를 불러와서 상관관계 그래프를 작성하도록 한다.
-   먼저 train & validation 데이터를 합치도록 한다.

```{r}

```

-   시각화를 작성해본다.

```{r, fig.width=5, fig.height=5}

```

-   위 그래프를 보면, `Loan_Status`와 가장 연관성이 큰 데이터는 `Credit_History`이다. 상식적으로 생각해도, `기존 대출 이력`이 있는 사람에게 더 많은 대출을 하고자 하는 은행의 경향성을 생각하면 대략적으로 이해가 가는 결과임을 알 수 있다.

## Workflow Sets

-   Recipe List와 Model List를 만들어 본다.

```{r}

```

-   workflow_sets()를 활용하여 최종적인 model_set를 완료한다.
-   `cross = T`는 recipe의 각 조건과 머신러닝 알고리즘과 매칭되는 모든 가능한 조건들을 Combination 하도록 허락하는 설정으로 이해하면 된다.

```{r}

```

## 모델 학습

-   이제 모델을 학습해보도록 한다.

```{r}

```

### 모델학습 비교
- 이제 모형 학습이 완료가 되었다면, 시각화로 어떤 모델이 좋은지를 확인해보도록 한다. 
- 우선 학습된 데이터를 확인해보도록 한다. 
```{r}

```

- 현재 결과물에서 `accuracy`에서 추출하고, 그 외 필요한 데이터 가공을 진행하도록 한다. 

```{r}

```

