---
title: "day_1_data_import"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 

## 대회 개요
- 

## 데이터 파일 구조
- 데이터 파일 구조는 크게 2가지로 나뉠 수 있다. 

![](img/map.png)

- Credit Bureau 파일 구조와 Home Credit 파일 구조로 분리할 수 있음. 
- Bureau (External File)
- Home Credit (Internal File)
  + 현재 Home Credit File (Application train/test)
  + 이전 Home Credit File (Other's)
  
## 평가 지표
- 제출한 파일은 예측 확률과 기존 관측 대상 사이의 [ROC Curve](http://en.wikipedia.org/wiki/Receiver_operating_characteristic)로 평가 한다. 

# 분석 준비

## 패키지 불러오기
- 주요 패키지를 불러오도록 한다. 

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(skimr)
library(GGally)
library(plotly)
library(viridis)
library(caret)
library(DT)
library(data.table)
library(lightgbm)
library(kableExtra)
```

## 데이터 불러오기
- 이번에는 `fread()`를 활용하여 데이터를 불러도록 한다. 

```{r}
na_strings = c("NA", "NaN", "?", "")
train = fread('data/home-credit-default-risk/application_train.csv', 
              stringsAsFactors = FALSE, 
              data.table = FALSE, na.strings = na_strings)

train %>% skim()
```

```{r}
test = fread('data/home-credit-default-risk/application_test.csv', 
              stringsAsFactors = FALSE, 
              data.table = FALSE, na.strings = na_strings)

dim(test)
```
```{r}
bureau = fread('data/home-credit-default-risk/bureau.csv', 
              stringsAsFactors = FALSE, 
              data.table = FALSE, na.strings = na_strings)

dim(bureau)
bureau %>% skim()
```
```{r}
prev = fread('data/home-credit-default-risk/previous_application.csv', 
              stringsAsFactors = FALSE, 
              data.table = FALSE, na.strings = na_strings)

dim(prev)
prev %>% skim()
```

# 주요 변수 시각화
## Target
- 우선 Target Variable의 데이터를 확인해본다. 
- 먼저 데이터 요약을 해보자. 
```{r}
train %>% 
  group_by(TARGET) %>%
  summarise(Count = n())
```

- 전체적인 비율을 구해본다. 

```{r}
# fillColor = "#FFA07A"
# fillColor2 = "#F1C40F"
# fillColorLightCoral = "#F08080"

train %>% 
  group_by(TARGET) %>%
  summarise(Count = n() / nrow(train) * 100) %>% 
  arrange(desc(Count)) %>% 
  ungroup() %>% 
  mutate(TARGET = reorder(TARGET, Count)) %>% 
  ggplot(aes(x = TARGET, y = Count)) + 
    geom_bar(stat = "identity", fill = "#F1C40F") + 
    geom_text(aes(x = TARGET, y = 1, label = paste0(round(Count, 2), " %")), 
              hjust = 0, vjust = .5, size = 3.5, colour = "white", fontface = "bold") + 
    coord_flip() + 
    labs(x = "TARGET", 
         y = "Percentage (%)", 
         title = "Percentage of Target Data (N = 307,511)", 
         subtitle = "0 - Capable to Repay Debt; 1 - Not Capable to Repay Debt", 
         caption = "Created by McBert") + 
    theme_minimal()
```

## Gender

- 이번에는 Gender의 숫자를 구해본다. 

```{r}
train %>% 
  group_by(CODE_GENDER) %>%
  summarise(Count = n())
```

- 이번에는 TARGET ~ TARGET 데이터를 요약해본다. 
```{r}
train %>% 
  group_by(CODE_GENDER, TARGET) %>%
  summarise(Count = n())
```


- 이번에는 시각화를 해본다. 
```{r}
train %>% 
  group_by(CODE_GENDER, TARGET) %>%
  summarise(Count = n() / nrow(train) * 100) %>% 
  arrange(desc(Count)) %>% 
  ungroup() %>% 
  mutate(CODE_GENDER = reorder(CODE_GENDER, Count), 
         TARGET = as.factor(TARGET)) %>% 
  ggplot(aes(x = CODE_GENDER, y = Count, fill = TARGET)) + 
    geom_bar(stat = "identity", position = position_dodge(width = 1)) + 
    geom_text(aes(x = CODE_GENDER, y = Count + 2, label = paste0(round(Count, 2), " %"), group = TARGET), 
              position = position_dodge(width = 1), size = 3.5, colour = "black", fontface = "bold") + 
    labs(x = "Gender", 
         y = "Percentage (%)", 
         title = "Percentage of Target ~ Gender Data (N = 307,511)", 
         subtitle = "0 - Capable to Repay Debt; 1 - Not Capable to Repay Debt", 
         caption = "Created by McBert") + 
    scale_fill_manual(values = c("#F5896E", "#7BDCFF")) + 
    theme_minimal()
```

## AMT CREDIT 
- 이번에는 대출 잔액을 확인해본다. 
```{r}
summary(train$AMT_CREDIT)
```
- 데이터의 분포도를 그려보도록 한다. 
```{r}
train %>% 
  ggplot(aes(x = AMT_CREDIT)) + 
  geom_histogram(bins = 30, fill = "#F5896E") + 
  labs(x = "Amount Credit", 
       y = "Count", 
       title = "Distribution of Amount Credit", 
       caption = "Created by McBert") + 
  theme_minimal()
```
- 이상치를 제거하도록 한다. 
  + 상위 2.5%는 제거하도록 한다. 

```{r}
upper_threshold = quantile(train$AMT_CREDIT, 0.975)
cat("Top 2.5% threshold is:", upper_threshold)

train %>% 
  filter(AMT_CREDIT <= upper_threshold) %>% 
  ggplot(aes(x = AMT_CREDIT)) + 
  geom_histogram(bins = 30, fill = "#F5896E") + 
  labs(x = "Amount Credit", 
       y = "Count", 
       title = "Distribution of Amount Credit", 
       caption = "Created by McBert") + 
  theme_minimal()
```

## TARGET ~ Age, Gender, Status 
- 이번에는 조건문을 활용하여 데이터를 요약하고, 시각화를 진행해본다. 
```{r}
train$DAYS_BIRTH[1:5]
```

```{r}
train$CODE_GENDER[1:5]
```

```{r}
table(train$CNT_FAM_MEMBERS)
```

```{r}
table(train$NAME_FAMILY_STATUS)
```



```{r}
train %>% 
  filter(!is.na(TARGET), CODE_GENDER != "XNA", CNT_FAM_MEMBERS <= 4) %>% # nrow() ~ 303498
  group_by(age = -round(DAYS_BIRTH/365, 0), 
           gender = ifelse(CODE_GENDER == "M", "Male", "Female"), 
           status = ifelse(NAME_FAMILY_STATUS == "Civil marriage", "Married", 
                           ifelse(NAME_FAMILY_STATUS == "Single / not married", "Single", as.character(NAME_FAMILY_STATUS)))) %>% # select(NAME_FAMILY_STATUS)
  summarise(count = n(), 
            AVG_CREDIT = mean(AMT_CREDIT), 
            AVG_TARGET = mean(TARGET)) %>% 
  mutate(AVG_TARGET = pmin(pmax(AVG_TARGET, 0.00), 0.20) * 100) %>% 
  ggplot(aes(x = age, y = count, fill = AVG_TARGET)) + 
    geom_histogram(stat = "identity", width = 1) + 
    facet_grid(gender ~ status) + 
    scale_fill_gradient("Avg. Default Rate %", low = "white", high = "blue") + 
    labs(title = "Default Rate of Applicants (N = 303,498)", 
         subtitle = "Age, Gender, And Marriage Status", 
         caption = "Created by McBert") +   
    theme_minimal()
```
- 상대적으로 Single, Male 그룹이 다른 그룹보다 Default 비율이 높았다. 
- 또한, 상대적으로 연령대가 낮을수록 Default 비율이 높았다. 

## Dept/Incomes Ratio %
- Dept의 비율이 높으면 높으수록 Default 비율도 높을 것으로 예상할 수 있다. 실제로 그런지 확인해본다. 
```{r}
library(scales)
train %>% 
  filter(!is.na(TARGET), CODE_GENDER != "XNA", CNT_FAM_MEMBERS <= 4) %>% 
  mutate(CODE_GENDER = ifelse(CODE_GENDER == "M", "Male", "Female"), 
         DEPT_INCOMES_RATIO = AMT_ANNUITY/AMT_INCOME_TOTAL) %>% 
  select(CODE_GENDER, DEPT_INCOMES_RATIO, TARGET) %>%
  ggplot(aes(x = DEPT_INCOMES_RATIO, y = TARGET)) + 
    geom_smooth(se = FALSE) + 
    scale_x_continuous(name = "Debt / Incomes Ratio (%)", 
                       limits = c(0, 0.5), 
                       labels = percent_format(accuracy = 0.1)) + 
    # coord_cartesian(ylim=c(0.00, 0.15)) + 
    scale_y_continuous(name = "Avg. Default Rate (%)", 
                       breaks = seq(0, 1, 0.01), 
                       labels = percent_format(accuracy = 0.1)) + 
    facet_grid(~ CODE_GENDER) + 
    theme_minimal()
```

## Bureau Data

## (과제) 개인별 시각화 인사이트 찾기
- 지금까지의 작성방법을 토대로 다양하게 시각화를 작성해본다. 

# 
